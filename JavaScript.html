<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function scrollToBottom() {
        // สมมติว่าปุ่ม Save ของคุณมี id="save_btn"
        const saveBtn = document.getElementById('save_btn');
        if (saveBtn) {
            saveBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            // ถ้าหาปุ่ม Save ไม่เจอ ให้เลื่อนลงล่างสุดแทน
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
    }


    // รายการตรวจสอบ 1
    // ฟังก์ชันสร้างช่องเบรกเกอร์
    function generateBreakerFields() {
        const qty = document.getElementById('breaker_qty').value;
        const container = document.getElementById('breaker_container');
        container.innerHTML = '';
        for (let i = 1; i <= qty; i++) {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">เบรกเกอร์ตัวที่ ${i}</label>
                <div class="input-group" style="margin-top:10px;">
                    <input type="number" class="breaker_input_val" min="0" placeholder="ค่า A (เช่น 10)" style="width:100%; padding:10px; margin-bottom:10px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span>สถานะ :</span>
                        <input type="radio" name="breaker_status_${i}" value="ปกติ"> ปกติ
                        <input type="radio" name="breaker_status_${i}" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่องมอเตอร์เบรกเกอร์
    function generateMotorFields() {
        const qty = document.getElementById('motor_qty').value;
        const container = document.getElementById('motor_container');
        container.innerHTML = '';
        for (let i = 1; i <= qty; i++) {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">มอเตอร์เบรกเกอร์ตัวที่ ${i}</label>
                <div class="input-group" style="margin-top:10px;">
                    <input type="number" class="motor_input_val" min="0" placeholder="ค่า A (เช่น 10)" style="width:100%; padding:10px; margin-bottom:10px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span>สถานะ :</span>
                        <input type="radio" name="motor_status_${i}" value="ปกติ"> ปกติ
                        <input type="radio" name="motor_status_${i}" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่อง Phase Protection
    function generatePhaseFields() {
        const qty = document.getElementById('phase_qty').value;
        const container = document.getElementById('phase_container');
        container.innerHTML = '';
        if (qty == "1") {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
              <label style="color:#004d99;">ผลการตรวจสอบ Phase Protection</label>
              <div style="display: flex; gap: 15px; align-items: center;">
                  <span>สถานะ :</span>
                  <input type="radio" name="phase_status" value="ปกติ"> ปกติ
                  <input type="radio" name="phase_status" value="ไม่ปกติ"> ไม่ปกติ
              </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่องฟิวส์ + ลูกฟิวส์
    function generateFuseFields() {
        const qty = document.getElementById('fuse_qty').value;
        const container = document.getElementById('fuse_container');
        container.innerHTML = '';
        if (qty == "1") {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
              <label style="color:#004d99;">ผลการตรวจสอบ ฟิวส์ + ลูกฟิวส์</label>
              <div style="display: flex; gap: 15px; align-items: center;">
                  <span>สถานะ :</span>
                  <input type="radio" name="fuse_status" value="ปกติ"> ปกติ
                  <input type="radio" name="fuse_status" value="ไม่ปกติ"> ไม่ปกติ
              </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่องแมกเนติก
    function generateMagneticFields() {
        const qty = document.getElementById('magnetic_qty').value;
        const mainStatusContainer = document.getElementById('magnetic_main_status_container');
        const container = document.getElementById('magnetic_container');

        mainStatusContainer.innerHTML = '';
        container.innerHTML = '';

        if (qty === "1") {
            // ส่วนที่ 1: สถานะแมกเนติกหลัก
            mainStatusContainer.innerHTML = `
            <div class="input-group" style="background: #ffffff; padding: 15px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #004d99;">
                <label style="color:#004d99; font-weight:bold;">ผลการตรวจสอบแมกเนติก</label>
                <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                    <span>สถานะ :</span>
                    <input type="radio" name="magnetic_main_status" value="ปกติ"> ปกติ
                    <input type="radio" name="magnetic_main_status" value="ไม่ปกติ"> ไม่ปกติ
                </div>
            </div>`;

            // ส่วนที่ 2: รายละเอียดตัวล็อคและการทำงาน
            container.innerHTML = `
            <div class="input-group" style="background: #f0f4f8; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4d82b8; margin-left: 10px;">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="color:#004d99; font-weight:bold; font-size: 14px;">1. ผลตรวจตัวล็อคแมกเนติก</label>
                    <select id="mag_lock_select" onchange="toggleRadio(this, 'radio_lock_box')" required style="width:100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px;">
                        <option value="" disabled selected hidden>เลือกการติดตั้ง</option>
                        <option value="ติดตั้ง">ติดตั้ง</option>
                        <option value="ไม่ติดตั้ง">ไม่ติดตั้ง</option>
                    </select>
                    <div id="radio_lock_box" style="display:none; margin-top:8px; padding-left:10px; font-size: 14px;">
                        <span>สถานะ :</span>
                        <input type="radio" name="mag_lock_status" value="ปกติ"> ปกติ
                        <input type="radio" name="mag_lock_status" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>

                <div class="input-group" style="margin-bottom: 5px;">
                    <label style="color:#004d99; font-weight:bold; font-size: 14px;">2. ผลตรวจการทำงานแมกเนติก</label>
                    <select id="mag_work_select" onchange="toggleRadio(this, 'radio_work_box')" required style="width:100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px;">
                        <option value="" disabled selected hidden>เลือกการติดตั้ง</option>
                        <option value="ติดตั้ง">ติดตั้ง</option>
                        <option value="ไม่ติดตั้ง">ไม่ติดตั้ง</option>
                    </select>
                    <div id="radio_work_box" style="display:none; margin-top:8px; padding-left:10px; font-size: 14px;">
                        <span>สถานะ :</span>
                        <input type="radio" name="mag_work_status" value="ปกติ"> ปกติ
                        <input type="radio" name="mag_work_status" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>
            </div>`;
        }
    }

    // ฟังก์ชันสร้างช่อง Overload
    function generateOvlFields() {
        const qty = document.getElementById('ovl_qty').value;
        const container = document.getElementById('ovl_container');
        container.innerHTML = '';
        for (let i = 1; i <= qty; i++) {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">Overload ตัวที่ ${i}</label>
                  <div style="display: flex; gap: 15px; align-items: center;">
                      <span>สถานะ :</span>
                      <input type="radio" name="ovl_status_${i}" value="ปกติ"> ปกติ
                      <input type="radio" name="ovl_status_${i}" value="ไม่ปกติ"> ไม่ปกติ
                  </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่อง Manual
    function generateManualFields() {
        const qty = document.getElementById('manual_qty').value;
        const container = document.getElementById('manual_container');
        container.innerHTML = '';
        for (let i = 1; i <= qty; i++) {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">Manual ตัวที่ ${i}</label>
                  <div style="display: flex; gap: 15px; align-items: center;">
                      <span>สถานะ :</span>
                      <input type="radio" name="manual_status_${i}" value="ปกติ"> ปกติ
                      <input type="radio" name="manual_status_${i}" value="ไม่ปกติ"> ไม่ปกติ
                  </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่อง Auto
    function generateAutoFields() {
        const qty = document.getElementById('auto_qty').value;
        const container = document.getElementById('auto_container');
        container.innerHTML = '';
        for (let i = 1; i <= qty; i++) {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">Auto ตัวที่ ${i}</label>
                  <div style="display: flex; gap: 15px; align-items: center;">
                      <span>สถานะ :</span>
                      <input type="radio" name="auto_status_${i}" value="ปกติ"> ปกติ
                      <input type="radio" name="auto_status_${i}" value="ไม่ปกติ"> ไม่ปกติ
                  </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่อง ทำงาน Inverter
    function generateInverterFields() {
        const qty = document.getElementById('inverter_qty').value;
        const container = document.getElementById('inverter_container');
        container.innerHTML = '';
        if (qty == "1") {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
              <label style="color:#004d99;">การทำงาน Inverter</label>
              <div style="display: flex; gap: 15px; align-items: center;">
                  <span>สถานะ :</span>
                  <input type="radio" name="inverter_status" value="ปกติ"> ปกติ
                  <input type="radio" name="inverter_status" value="ไม่ปกติ"> ไม่ปกติ
              </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่อง สถานะหลอด
    function generateLedFields() {
        const qty = document.getElementById('led_qty').value;
        const container = document.getElementById('led_container');
        container.innerHTML = '';
        if (qty == "1") {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
              <label style="color:#004d99;">ผลการตรวจสอบแสดงสถานะหลอด</label>
              <div style="display: flex; gap: 15px; align-items: center;">
                  <span>สถานะ :</span>
                  <input type="radio" name="led_status" value="ปกติ"> ปกติ
                  <input type="radio" name="led_status" value="ไม่ปกติ"> ไม่ปกติ
              </div>`;
            container.appendChild(div);
        }
    }

    // รายการตรวจสอบ 2
    // ฟังก์ชันสร้างช่อง Low Level
    function generateLowlvFields() {
        const qty = document.getElementById('lowlv_qty').value;
        const container = document.getElementById('lowlv_container');
        container.innerHTML = '';
        if (qty === "1") {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">ชนิดอุปกรณ์ Low Level</label>
                <div class="input-group" style="margin-top:10px;">
                    <input type="text" id="lowlv_input_type" placeholder="ชนิดอุปกรณ์" style="width:100%; padding:10px; margin-bottom:10px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span>สถานะ :</span>
                        <input type="radio" name="lowlv_status_type" value="ปกติ"> ปกติ
                        <input type="radio" name="lowlv_status_type" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>

                <label style="color:#004d99;">การเข้าสายถูกต้อง</label>
                <div class="input-group" style="margin-top:10px;">
                    <input type="text" id="lowlv_input_wire" placeholder="ชนิดอุปกรณ์" style="width:100%; padding:10px; margin-bottom:10px;">               
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span>สถานะ :</span>
                        <input type="radio" name="lowlv_status_wire" value="ปกติ"> ปกติ
                        <input type="radio" name="lowlv_status_wire" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันสร้างช่อง High Level
    function generateHighlvFields() {
        const qty = document.getElementById('highlv_qty').value;
        const container = document.getElementById('highlv_container');
        container.innerHTML = '';
        if (qty === "1") {
            const div = document.createElement('div');
            div.style = "background: #f0f4f8; padding: 15px; border-radius: 10px; margin-top: 15px; margin-bottom: 15px; border-left: 5px solid #004d99;";
            div.innerHTML = `
                <label style="color:#004d99;">ชนิดอุปกรณ์ High Level</label>
                <div class="input-group" style="margin-top:10px;">
                    <input type="text" id="highlv_input_type" placeholder="ชนิดอุปกรณ์" style="width:100%; padding:10px; margin-bottom:10px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span>สถานะ :</span>
                        <input type="radio" name="highlv_status_type" value="ปกติ"> ปกติ
                        <input type="radio" name="highlv_status_type" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>

                <label style="color:#004d99;">การเข้าสายถูกต้อง</label>
                <div class="input-group" style="margin-top:10px;">
                    <input type="text" id="highlv_input_wire" placeholder="ชนิดอุปกรณ์" style="width:100%; padding:10px; margin-bottom:10px;">
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <span>สถานะ :</span>
                        <input type="radio" name="highlv_status_wire" value="ปกติ"> ปกติ
                        <input type="radio" name="highlv_status_wire" value="ไม่ปกติ"> ไม่ปกติ
                    </div>
                </div>`;
            container.appendChild(div);
        }
    }

    // ฟังก์ชันเปิด-ปิดการแสดง Radio button
    function toggleRadio(selectElement, targetId) {
        const radioDiv = document.getElementById(targetId);
        if (selectElement.value === "ติดตั้ง") {
            radioDiv.style.display = "block";
        } else {
            radioDiv.style.display = "none";
        }
    }

    // --- ส่วนจัดการ Canvas ---
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        ctx.scale(ratio, ratio);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        return {
            x: (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left,
            y: (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top
        };
    };
    const start = (e) => { drawing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); e.preventDefault(); };
    const draw = (e) => { if (!drawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault(); };
    const end = () => { drawing = false; };
    canvas.addEventListener('mousedown', start); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', start); canvas.addEventListener('touchmove', draw); canvas.addEventListener('touchend', end);
    document.getElementById('clear').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

    // --- ส่วนเก็บข้อมูลส่งไป Google Sheets / Docs ---
    document.getElementById('save').onclick = () => {

        if (!checkForm()) {
            return;
        }

        document.getElementById('save').innerText = "กำลังส่ง...";
        document.getElementById('save').disabled = true;
        google.script.run.withSuccessHandler(msg => {
            alert(msg);
            location.reload();
        }).withFailureHandler(err => {
            alert("เกิดข้อผิดพลาด: " + err);
            document.getElementById('save').disabled = false;
            document.getElementById('save').innerText = "ส่งข้อมูล";
        }).processForm({
            project: project,
            date: date,
            fromNo: fromNo,
            boqNo: boqNo,
            productNo: productNo,
            pumpType: pumpType,
            motorType: motorType,
            motorKw: motorKw,
            motorSpeed: motorSpeed,
            breakerDetail: bDetail,
            motorDetail: mDetail,
            phaseDetail: pDetail,
            fuseDetail: fDetail,
            magneticDetail: magneticDetail,
            overloadDetail: overloadDetail,
            manualDetail: manualDetail,
            autoDetail: autoDetail,
            inverterDetail: inverterDetail,
            ledDetail: ledDetail,
            lowlvDetail: lowlvDetail,
            highlvDetail: highlvDetail,
            type_product: type_product,
            design: design,
            status: status,
            check1: check1,
            check2: check2,
            check3: check3,
            check4: check4,
            check5: check5,
            check6: check6,
            footletrod_count: footletrod_count,
            footlethead_count: footlethead_count,
            footletjoint_count: footletjoint_count,
            float_count: float_count,
            cup_type: cup_type,
            cup_count: cup_count,
            signature: signature
        });
    };

</script>